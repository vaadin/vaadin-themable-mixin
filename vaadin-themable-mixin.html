<link rel="import" href="../polymer/lib/elements/dom-module.html">

<script>
  if (Polymer && Polymer.version.indexOf('2.') !== 0) {
    throw new Error(`Unexpected Polymer version ${Polymer.version} is used, expected v2.0.0 or later.`);
  }

  window.Vaadin = window.Vaadin || {};

  /**
   * @polymerMixin
   */
  Vaadin.ThemableMixin = superClass => class VaadinThemableMixin extends superClass {

    static get template() {
      const modules = Polymer.DomModule.prototype.modules;

      if (super.template && !this.hasOwnProperty('_memoizedThemableMixinTemplate')) {
        this._memoizedThemableMixinTemplate = super.template.cloneNode(true);

        let hasThemes = false;
        const defaultModuleName = this.is + '-default-theme';

        Object.keys(modules)
          .sort((moduleNameA, moduleNameB) => {
            const vaadinA = moduleNameA.indexOf('vaadin-') === 0;
            const vaadinB = moduleNameB.indexOf('vaadin-') === 0;

            const vaadinThemePrefixes = ['lumo-', 'material-'];
            const vaadinThemeA = vaadinThemePrefixes.filter(prefix => moduleNameA.indexOf(prefix) === 0).length > 0;
            const vaadinThemeB = vaadinThemePrefixes.filter(prefix => moduleNameB.indexOf(prefix) === 0).length > 0;

            if (vaadinA !== vaadinB) {
              // Include vaadin core styles first
              return vaadinA ? -1 : 1;
            } else if (vaadinThemeA !== vaadinThemeB) {
              // Include vaadin theme styles after that
              return vaadinThemeA ? -1 : 1;
            } else {
              // Lastly include custom styles so they override all vaadin styles
              return 0;
            }
          })
          .forEach(moduleName => {
            if (moduleName !== defaultModuleName) {
              const themeFor = modules[moduleName].getAttribute('theme-for');
              if (themeFor) {
                themeFor.split(' ').forEach(themeForToken => {
                  if (new RegExp('^' + themeForToken.split('*').join('.*') + '$').test(this.is)) {
                    hasThemes = true;
                    this._includeStyle(moduleName);
                  }
                });
              }
            }
          });

        if (!hasThemes && modules[defaultModuleName]) {
          // No theme modules found, include the default module if it exists
          this._includeStyle(defaultModuleName);
        }
      }
      return this._memoizedThemableMixinTemplate;
    }

    /** @private */
    static _includeStyle(moduleName) {
      const styleEl = document.createElement('style');
      styleEl.setAttribute('include', moduleName);
      this._memoizedThemableMixinTemplate.content.appendChild(styleEl);
    }

  };
</script>
