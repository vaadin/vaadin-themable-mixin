<!doctype html>

<head>
  <meta charset="UTF-8">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../styler.html">
  <link rel="import" href="../vaadin-themable-mixin.html">
  <link rel="import" href="../../polymer/polymer-element.html">
  <link rel="import" href="../../test-fixture/test-fixture.html">
</head>

<body>

  <script>

    let attachedInstances = [];

    function define(customElementName) {
      customElements.define(customElementName, class extends Vaadin.ThemableMixin(Polymer.Element) {
        static get is() {
          return customElementName;
        }

        static get template() {
          return Polymer.html`foo`;
        }
      });
    }

    function defineAndInstantiate(customElementName) {
      define(customElementName);

      const instance = document.createElement(customElementName);
      document.body.appendChild(instance);
      attachedInstances.push(instance);
      return instance;
    }

    afterEach(() => {
      attachedInstances.forEach(instance => {
        document.body.removeChild(instance);
      });
      attachedInstances = [];
    });

    describe('styler', () => {
      let style;
      let testId = 0;

      function unique(seed = 'bar') {
        return `foo-${testId}-${seed}`;
      }

      beforeEach(() => {
        style = Vaadin.createStyle(`
          :host {
            color: rgb(255, 0, 0);
          }
        `);
        testId++;
      });

      it('should add theme for a component', () => {
        style.registerForComponent(unique());

        const instance = defineAndInstantiate(unique());
        expect(window.getComputedStyle(instance).color).to.equal('rgb(255, 0, 0)');
      });

      it('should add multiple themes for a component', () => {
        style.registerForComponent(unique());
        Vaadin.createStyle(`:host {
          background-color: rgb(0, 255, 0);
        }`).registerForComponent(unique());

        const instance = defineAndInstantiate(unique());
        expect(window.getComputedStyle(instance).color).to.equal('rgb(255, 0, 0)');
        expect(window.getComputedStyle(instance).backgroundColor).to.equal('rgb(0, 255, 0)');
      });

      it('should add theme for a component and id', () => {
        style.registerForComponent(unique(), unique('id'));

        Vaadin.createStyle()
          .include(unique('id'))
          .registerForComponent(unique('component'));

        const instance = defineAndInstantiate(unique('component'));
        expect(window.getComputedStyle(instance).color).to.equal('rgb(255, 0, 0)');
      });

      it('should warn about registering the style too late', () => {
        defineAndInstantiate(unique());
        const warn = sinon.stub(console, 'warn');
        style.registerForComponent(unique());

        expect(warn.called).to.be.true;
        warn.restore();
      });

      it('should not warn about registering the style too late', () => {
        const warn = sinon.stub(console, 'warn');
        style.registerForComponent(unique());

        expect(warn.called).to.be.false;
        warn.restore();
      });

      it('should not warn about registering the style too late 2', () => {
        define(unique());
        const warn = sinon.stub(console, 'warn');
        style.registerForComponent(unique());

        expect(warn.called).to.be.false;
        warn.restore();
      });

      it('should register with id', () => {
        style.registerWithId(unique('styles'));
        Vaadin.createStyle()
          .include(unique('styles'))
          .registerForComponent(unique('component'));

        const instance = defineAndInstantiate(unique('component'));
        expect(window.getComputedStyle(instance).color).to.equal('rgb(255, 0, 0)');
      });

      it('should register with id and include', () => {
        style.registerWithId(unique('styles'));
        Vaadin.createStyle()
          .include(unique('styles'))
          .registerWithId(unique('styles2'));
        Vaadin.createStyle()
          .include(unique('styles2'))
          .registerForComponent(unique());

        const instance = defineAndInstantiate(unique());
        expect(window.getComputedStyle(instance).color).to.equal('rgb(255, 0, 0)');
      });

    });
  </script>
